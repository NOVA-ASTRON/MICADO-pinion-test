#include "mainwindow.h"
#include "ui_mainwindow.h"

#include <logfile.h>
#include <QWidget>

MainWindow::MainWindow(QWidget *parent)
    : QMainWindow(parent)
    , ui(new Ui::MainWindow)
{
    ui->setupUi(this);
    chart = new QChart();
    for (int i=0;i<num_series;i+=1){
        series[i] = new QLineSeries(chart);
        series[i]->append(0, 6);
        series[i]->append(2, 4);
        series[i]->append(3, 8);
        series[i]->append(7, 4);
        series[i]->append(10, 5);
        *series[i] << QPointF(11, 1) << QPointF(13, 3) << QPointF(17, 6) << QPointF(18, 3) << QPointF(20, 2);
    }


    chart->legend()->hide();
    for (int i=0;i<num_series;i+=1)
        chart->addSeries(series[i]);
    chart->createDefaultAxes();
    chart->setTitle("Simple line chart example");
    chart->axisY()->setRange(-10,10);
    ui->TorqueChart->setChart(chart);
    num=21;
    ui->TorqueChart->setRenderHint(QPainter::Antialiasing);

    std::string devname="phytron";
    const deviceinfo *ph=DeviceInfoFromName(devname);
    log=new LogFile_t("phytronlog.txt");
    phytron= new MotorDriver(ph,log,"phytron");
    if (phytron->getValid()){
        phytron->Init();
        ui->start_run_button->setEnabled(true);


    } else {
        delete phytron;
        phytron=nullptr;
    }
    timer = nullptr;

    TorqueSensorAvailable = TorqueSensor.Setup();


    // read data every 0.1 sec

    timer = new QTimer(this);

    // setup signal and slot
    connect(timer, SIGNAL(timeout()),
            this, SLOT(on_timer()));
    timer->start(100);
    if (cam.init_camera()){
        cam.setExposure(10000);
        cam.setup_callbacks();
        cam.start_capture();
    }

}

MainWindow::~MainWindow()
{
    if(phytron) delete phytron;
    if (log) delete log;
    delete ui;
}

void MainWindow::update_monitoring()
{
    series[0]->removePoints(0,1);
    *series[0]<<QPointF(num++, ui->led_intensity_horizontalSlider->value());
    series[0]->pointAdded(1);
    series[1]->removePoints(0,1);
    *series[1]<<QPointF(num++, ui->led_intensity_horizontalSlider_2->value());
    series[1]->pointAdded(1);

    chart->axisX()->setRange(series[0]->at(0).x(),series[0]->at(9).x());
}


void MainWindow::on_led_intensity_horizontalSlider_valueChanged(int value)
{
    update_monitoring();
}

void MainWindow::on_start_run_button_clicked()
{
    if (log && phytron){
        log->Write(QString::number(phytron->GetPos()).toStdString());
        //phytron->Move(ui->motor_total_revolutions_spinBox->value());
        phytron->Move(ui->motor_revolutions_per_direction_spinBox->value()*200);

    }
}

void MainWindow::on_led_intensity_horizontalSlider_2_valueChanged(int value)
{
    update_monitoring();
}

void MainWindow::on_timer()
{
    if (TorqueSensorAvailable){
        series[0]->removePoints(0,1);
        *series[0]<<QPointF(num++, TorqueSensor.get_AD(1));
        series[0]->pointAdded(1);
        chart->axisX()->setRange(series[0]->at(0).x(),series[0]->at(9).x());
    }

    QImage * im = cam.getImage();
    if (im){

        ui->image_camera_livestream->setPixmap(QPixmap::fromImage(*im,Qt::AutoColor));
    }
}

void MainWindow::on_camera_exp_time_spinBox_valueChanged(int arg1)
{
    cam.setExposure(arg1*1000);
}
